<!-- <!DOCTYPE html> -->
<!-- <html lang="ru"> -->

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Открываем магазин…</title>

  <!-- Скрываем реферер для партнёра -->
  <meta name="referrer" content="no-referrer" />
  <meta name="robots" content="noindex,nofollow">
  <link rel="stylesheet" href="./go.css">

  <!-- Fallback на случай отключённого JS: метаредирект через 2с (будет заменён скриптом на целевой URL) -->
  <meta id="meta-refresh" http-equiv="refresh" content="5;url=/" />
</head>

<body>
  <div class="card" role="status" aria-live="polite">
    <div class="row">
      <div class="spinner" aria-hidden="true"></div>
      <h1>Открываем магазин…</h1>
    </div>
    <p id="shopLine" class="hint">Подготавливаем страницу</p>
    <a id="directLink" class="btn" href="/" rel="noopener nofollow sponsored">Открыть сразу</a>
  </div>

  <script>
    // Читаем ?to=... и СРАЗУ чистим адресную строку (без перезагрузки),
    // чтобы пользователь не видел параметры партнёрки.
    const params = new URLSearchParams(location.search);
    const raw = (() => {
      if (params.has('to')) return params.get('to');        // поддержка старых ссылок
      if (!params.has('t')) return "";
      try {
        const b = params.get('t').replace(/-/g, '+').replace(/_/g, '/');
        return atob(b);
      } catch { return ""; }
    })();

    // Скрываем параметры из адресной строки (визуально)
    try { history.replaceState(null, '', location.pathname); } catch { }

    let url;
    try {
      url = new URL(raw);
    } catch {
      document.getElementById('shopLine').textContent = 'Некорректная ссылка. Возвращаем на главную…';
      setTimeout(() => location.replace('/'), 800);
    }

    // [Белый список трекинг-доменов] — минимальная защита от open-redirect
    const AFF_HOSTS = new Set([
      'bywiola.com', 'uuwgc.com', 'qwpeg.com', 'xpuvo.com',
      'admitad.com', 'actionpay.net', 'cityads.com', 'effiliation.com', 'advcake.com'
    ]);

    if (url) {
      // Если это известный трекер — показываем домен магазина (из ulp)
      try {
        const ulp = url.searchParams.get('ulp');
        let host = url.hostname;
        if (ulp) {
          const target = new URL(decodeURIComponent(ulp));
          host = target.hostname;
        }
        document.getElementById('shopLine').innerHTML = 'Магазин: <span class="domain">' + host + '</span>';
      } catch { }

      // Блокируем неразрешённые домены (против злоупотреблений параметром ?to=)
      if (!AFF_HOSTS.has(url.hostname)) {
        document.getElementById('shopLine').textContent = 'Неразрешённый домен. Возвращаем на главную…';
        setTimeout(() => location.replace('/'), 800);
      } else {
        const a = document.getElementById('directLink');
        a.href = url.toString();

        const mr = document.getElementById('meta-refresh');
        if (mr) mr.setAttribute('content', '3;url=' + encodeURI(url.toString()));

        setTimeout(() => {
          // Прямой переход (без реферера — см. <meta name="referrer" ...>)
          const tmp = document.createElement('a');
          tmp.href = url.toString();
          tmp.rel = 'noopener nofollow sponsored';
          tmp.target = '_self';
          tmp.click();
        }, 80);
      }
    }
  </script>

</body>

<!-- </html> -->